services:
  astra-artifact-service:
    build:
      context: ..
      dockerfile: services/artifact-service/Dockerfile
    container_name: astra-artifact-service
    restart: unless-stopped
    env_file:
      - ../services/artifact-service/.env.example
    environment:
      MONGO_URI: ${MONGO_URI:-mongodb+srv://sandeepk:sandeep@cluster0.tnbpi.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0}
      MONGO_DB: ${MONGO_DB:-astra}
      RABBITMQ_URI: ${RABBITMQ_URI:-amqp://raina:raina@host.docker.internal:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-raina.events}
      EVENTS_ORG: ${EVENTS_ORG:-astra}
      PLATFORM_EVENTS_ORG: ${PLATFORM_EVENTS_ORG:-platform}
      CONSUMER_QUEUE_WORKSPACE: ${CONSUMER_QUEUE_WORKSPACE:-platform.workspace.v1.astra}
      SERVICE_NAME: artifact-service
    ports:
      - "9020:9020"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  astra-capability-service:
    build:
      context: ..
      dockerfile: services/capability-service/Dockerfile
    container_name: astra-capability-service
    restart: unless-stopped
    env_file:
      - ../services/capability-service/.env.example
    environment:
      MONGO_URI: ${MONGO_URI:-mongodb+srv://sandeepk:sandeep@cluster0.tnbpi.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0}
      MONGO_DB: ${MONGO_DB:-astra}
      RABBITMQ_URI: ${RABBITMQ_URI:-amqp://raina:raina@host.docker.internal:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-raina.events}
      EVENTS_ORG: ${EVENTS_ORG:-astra}
      PLATFORM_EVENTS_ORG: ${PLATFORM_EVENTS_ORG:-platform}
      SERVICE_NAME: capability-service
    ports:
      - "9021:9021"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  astra-conductor-service:
    build:
      context: ..
      dockerfile: services/conductor-service/Dockerfile
      
    container_name: astra-conductor-service
    restart: unless-stopped
    env_file:
      - ../services/conductor-service/.env.example
    environment:
      MONGO_URI: ${MONGO_URI:-mongodb+srv://sandeepk:sandeep@cluster0.tnbpi.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0}
      MONGO_DB: ${MONGO_DB:-astra}
      RABBITMQ_URI: ${RABBITMQ_URI:-amqp://raina:raina@host.docker.internal:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-raina.events}
      EVENTS_ORG: ${EVENTS_ORG:-astra}
      PLATFORM_EVENTS_ORG: ${PLATFORM_EVENTS_ORG:-platform}
      CAPABILITY_SVC_BASE_URL: ${CAPABILITY_SVC_BASE_URL:-http://astra-capability-service:9021}
      ARTIFACT_SVC_BASE_URL: ${ARTIFACT_SVC_BASE_URL:-http://astra-artifact-service:9020}
      HTTP_CLIENT_TIMEOUT_SECONDS: ${HTTP_CLIENT_TIMEOUT_SECONDS:-30}
      SERVICE_NAME: conductor-service
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # NEW: make the workspace path explicit (optional but handy)
      WORKSPACE_FOLDER: /workspace
      WORKSPACE_MOUNT: /workspace
    ports:
      - "9022:9022"
    volumes:
      # NEW: mount your repo root into the container at /workspace
      - ../data/workspace:/workspace
    extra_hosts:
      - "host.docker.internal:host-gateway"

# NEW: Raina Input Service (FastAPI)
  astra-raina-input-service:
    build:
      context: ..
      dockerfile: services/raina-input-service/Dockerfile
    container_name: astra-raina-input-service
    restart: unless-stopped
    environment:
      SERVICE_NAME: raina-input-service
      APP_PORT: ${APP_PORT:-9023}
      # Optional CORS origins (comma-separated). "*" by default.
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS:-*}
    ports:
      - "9023:9023"
    extra_hosts:
      - "host.docker.internal:host-gateway"
